(function ($) {
    "use strict";
    function startTimeliner(c) {
        var d = {timelineContainer: '#timelineContainer', startState: 'closed', startOpen:
            [
            ], baseSpeed          : 200, speed: 4, fontOpen: '1.2em', fontClosed: '1em', expandAllText: '+ expand all', collapseAllText: '- collapse all'}, settings = $.extend(d, c), key, p, $value, $tlEvent = $(settings.timelineContainer + " " + ".timelineEvent");

        function openEvent(a, b) {
            $(a).removeClass('closed').addClass('open').animate({fontSize: settings.fontOpen}, settings.baseSpeed);
            $(b).show(settings.speed * settings.baseSpeed)
        }

        function closeEvent(a, b) {
            $(a).animate({fontSize: settings.fontClosed}, 0).removeClass('open').addClass('closed');
            $(b).hide(settings.speed * settings.baseSpeed)
        }

        if ($(settings.timelineContainer).data('started')) {
            return
        }
        $(settings.timelineContainer).data('started', true);
        $(settings.timelineContainer + " " + ".expandAll").html(settings.expandAllText);
        $(settings.timelineContainer + " " + ".collapseAll").html(settings.collapseAllText);
        if (settings.startState === 'closed') {
            $tlEvent.hide();
            p = settings.startOpen;
            for (key in p) {
                if (p.hasOwnProperty(key)) {
                    $value = $(p[key]);
                    openEvent($value.parent(settings.timelineContainer + ' .timelineMinor').find('dt a'), $value)
                }
            }
        } else {
            openEvent($(settings.timelineContainer + ' .timelineMinor').find('dt a'), $tlEvent)
        }
        $(settings.timelineContainer).on("click", ".timelineMinor dt", function () {
            var a = $(this), currentId = a.attr('id');
            if (a.find('a').is('.open')) {
                closeEvent($("a", this), $("#" + currentId + "EX"))
            } else {
                openEvent($("a", this), $("#" + currentId + "EX"))
            }
        });
        $(settings.timelineContainer).on("click", ".timelineMajorMarker", function () {
            var a = $(this), $tlMajor = a.parents(".timelineMajor"), $tlMM = $tlMajor.find("dt a", "dl.timelineMinor"), $tlEvent = $tlMajor.find(".timelineEvent"), numEvents = $tlMajor.find(".timelineMinor").length, numOpen = $tlMajor.find('.open').length;
            if (numEvents > numOpen) {
                openEvent($tlMM, $tlEvent)
            } else {
                closeEvent($tlMM, $tlEvent)
            }
        });
        $(settings.timelineContainer + " " + ".expandAll").click(function () {
            var a = $(this), $tlC = a.parents(settings.timelineContainer), $tlMinor = $tlC.find("dt a", "dl.timelineMinor"), $tlEvent = $tlC.find(".timelineEvent");
            if ($(this).hasClass('expanded')) {
                closeEvent($tlMinor, $tlEvent);
                $(this).removeClass('expanded').html(settings.expandAllText)
            } else {
                openEvent($tlMinor, $tlEvent);
                $(this).addClass('expanded').html(settings.collapseAllText)
            }
        })
    }

    $.timeliner = function (a) {
        if ($.timeliners === undefined) {
            $.timeliners = {options:
                [
                ]};
            $.timeliners.options.push(a)
        } else {
            $.timeliners.options.push(a)
        }
        $(document).ready(function () {
            var i = 0, len = $.timeliners.options.length;
            while (i < len) {
                startTimeliner($.timeliners.options[i]);
                i += 1
            }
        })
    }
})(jQuery);